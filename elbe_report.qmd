---
title: "Discharge of River Elbe: Homework Project"
format:
  html:
    toc: true
execute:
  echo: false
  warning: false
  message: false
params:
  data_path: "data/elbe_discharge.csv"
  datetime_col: "datetime"
  discharge_col: "Q"
  tz: "UTC"
---

```{r}
# Packages used in this report
suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(MASS)
})

source("R/elbe_helpers.R")

d <- read_elbe(
  path = params$data_path,
  datetime_col = params$datetime_col,
  discharge_col = params$discharge_col,
  tz = params$tz
)

period <- range(d$datetime, na.rm = TRUE)
```

## Introduction

This report analyzes River Elbe discharge data with a focus on (i) distribution shape and suitable distribution models / transformations, and (ii) identification and characterization of two dry and two wet years.

## Methods & Results

### Task 1: Distribution of discharge

**Observational period**: `r format(period[[1]], "%Y-%m-%d")` to `r format(period[[2]], "%Y-%m-%d")`.

#### Statistical parameters

```{r}
stats <- stats_table(d$Q)
knitr::kable(stats, digits = 3)
```

#### Distribution plots (select up to 4)

```{r}
# Histogram + density (raw)
ggplot(d, aes(Q)) +
  geom_histogram(aes(y = after_stat(density)), bins = 60) +
  geom_density(linewidth = 0.8) +
  theme_minimal() +
  labs(title = "Discharge distribution (raw)", x = "Q", y = "Density")
```

```{r}
# ECDF (raw) is often good for skewness / tails
# (Count this as a plot if you keep it.)
ggplot(d, aes(Q)) +
  stat_ecdf(linewidth = 0.8) +
  theme_minimal() +
  labs(title = "ECDF of discharge (raw)", x = "Q", y = "F(Q)")
```

```{r}
# QQ plot for log-transform vs Normal (shape check)
x <- d$Q
x <- x[is.finite(x) & x > 0]
y <- log(x)
qq <- tibble(
  sample = sort(y),
  theo = qnorm(ppoints(length(y)))
)

ggplot(qq, aes(theo, sample)) +
  geom_point(size = 0.8, alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0) +
  theme_minimal() +
  labs(title = "QQ plot: log(Q) vs Normal", x = "Theoretical quantiles", y = "Sample quantiles")
```

#### Compare distribution models

```{r}
# Note: adjust model set to match your lab sections.
# Here we compare common positive-support models.
x <- d$Q
x <- x[is.finite(x) & x > 0]

fits <- list(
  lognormal = MASS::fitdistr(x, "lognormal"),
  gamma = MASS::fitdistr(x, "gamma")
)

cmp <- purrr::imap_dfr(fits, function(f, name) {
  k <- length(f$estimate)
  tibble(model = name, logLik = f$loglik, AIC = -2 * f$loglik + 2 * k)
}) %>%
  arrange(AIC)

knitr::kable(cmp, digits = 2)
```

#### Interpretation (write-up)

- Explain which plot best shows the distribution shape (e.g., histogram+density for central mass, ECDF/QQ for tails).
- Discuss parameters (min/max/mean/median/geom mean/quartiles) together with skewness and tail behavior.
- Compare transformations (none, log, sqrt) and justify which is most appropriate.

Optional: estimate 100-year flood via right one-sided 1% prediction interval, based on your chosen model.

### Task 2: Dry and wet years

```{r}
years <- identify_dry_wet_years(d, n = 2)
annual <- years$annual
dry2 <- years$dry
wet2 <- years$wet

dry2
wet2
```

```{r}
# Seasonal signature helper table for choosing contrasting years
sig <- seasonal_signature(d)
head(sig, 10)
```

```{r}
# Plot idea: time series for the 4 selected years
sel_years <- c(dry2$year, wet2$year)

p_ts <- d %>%
  mutate(year = lubridate::year(datetime)) %>%
  filter(year %in% sel_years) %>%
  ggplot(aes(datetime, Q)) +
  geom_line(linewidth = 0.25) +
  facet_wrap(~ year, scales = "free_x", ncol = 2) +
  theme_minimal() +
  labs(title = "Discharge time series: selected dry/wet years", x = NULL, y = "Q")

p_ts
```

```{r}
# Plot idea: annual cumulative sums for the 4 selected years
p_cum <- d %>%
  mutate(year = lubridate::year(datetime)) %>%
  filter(year %in% sel_years) %>%
  group_by(year) %>%
  arrange(datetime, .by_group = TRUE) %>%
  mutate(day_index = row_number(), cumQ = cumsum(Q)) %>%
  ungroup() %>%
  ggplot(aes(day_index, cumQ, color = factor(year))) +
  geom_line(linewidth = 0.7) +
  theme_minimal() +
  labs(title = "Annual cumulative discharge (selected years)", x = "Index within year", y = "Cumulative Q", color = "Year")

p_cum
```

## Discussion

Connect the statistical parameters and figures, justify the preferred transformation/model, and discuss the chosen dry/wet years and their seasonal characteristics.

Include 2–3 literature references (author–year style).

## References

- Add your references here (APA / author–year).
